---
- name: disable server in haproxy
  haproxy:
    state: disabled
    host: "{{ inventory_hostname }}"
    socket: /var/lib/haproxy/stats
  delegate_to: loadbalancer.ibm.nontoonyt.com

- name: clone app repo
  git:
    dest: /var/www/html
    repo: https://github.com/wzzrd/automates_webapp
    version: "{{ app_version }}"
    force: yes

- name: replace app token
  replace:
    path: /var/www/html/index.html
    regexp: REPLACE_THIS_TOKEN
    replace: "{{ hostvars[inventory_hostname]['ansible_local']['facts']['cloud'] }}"

- name: wait a bit
  pause:
    seconds: 30
    echo: no

- name: enable server in haproxy
  haproxy:
    state: enabled
    host: "{{ inventory_hostname }}"
    socket: /var/lib/haproxy/stats
  delegate_to: loadbalancer.ibm.nontoonyt.com